<?xml version="1.0" encoding="UTF-8"?>
<!-- Шаблон отчета по бонусам. -->
<report name = "bonusreport" type="shift" cached="true" title="Отчет по бонусам">
<text padding="2">ОТЧЕТ ПО БОНУСАМ</text><br/>
<text fillsymbol="-" maxwidth="all"/><br/>
<text>КАССА        : $cash.code$</text><br/>
<text>СМЕНА        : $shift.num$</text><br/>
<text>ВРЕМЯ         : </text><var name="now" dateformat="dd/mm/yyyy hh:mi"/><br/>
<text>НАПЕЧАТАЛ    : $user.code$ $user.name$</text><br/>
<select query="select c.okpo terminal from documents.carditem c limit 1">
<text>ТЕРМИНАЛ     : </text><var name="terminal"/><br/>
</select>
<text fillsymbol="=" maxwidth="all"/><br/>
<text>ОПЕРАЦИИ С БОНУСАМИ</text><br/>
<text fillsymbol="-" maxwidth="all"/><br/>
<select query="select c.document rrn, d.checknum dnum,c.number bcard, d.documentid docid, d.time_end ddate
from documents.carditem c, documents.document d WHERE d.documentid = c.documentid and d.workshiftid=$shift.id$ order by d.checknum">
      <var name="ddate" dateformat="dd/mm/yyyy hh:mi" align="left"/><var name="dnum" align="right" maxwidth="all" numberformat="06"/><br/>
      <text>Карта     : </text><var name="bcard"/><br/>
      <text>RRN       : </text><var name="rrn"/><br/>
      
      <select query="SELECT  coalesce(sum(b.amount),0) bsum
      FROM  documents.bonusitem b , documents.goodsitem g where b.goodsitemid = g.goodsitemid and g.documentid =  $docid$">
            <text>Начислено : </text>
            <var name="bsum" minwidth="10" maxwidth="all" afterpoint="2" align="right"/><br/>
      </select>
      <select query="SELECT  coalesce(sum(d.discsum),0) dsum
      FROM  documents.discitem d , documents.goodsitem g where d.goodsitemid = g.goodsitemid and d.disctype = 5 and g.documentid =  $docid$">
            <text>Списано   : </text>
            <var name="dsum" minwidth="10" maxwidth="all" afterpoint="2" align="right"/><br/><br/>
      </select>
</select>
<text fillsymbol="-" maxwidth="all"/><br/>
<text>ИТОГО:</text><br/>
<select query="SELECT   coalesce(sum(b.amount),0) bsum
  FROM  documents.bonusitem b, documents.goodsitem g, documents.document d 
  where d.documentid = g.documentid and b.goodsitemid = g.goodsitemid and d.workshiftid = $shift.id$ ">
      <text>  Начислено : </text><var name="bsum" minwidth="10" maxwidth="all" afterpoint="2" align="right"/><br/>
</select>
<select query="SELECT   coalesce(sum(di.discsum),0) dsum
  FROM  documents.discitem di, documents.goodsitem g, documents.document d 
  where d.documentid = g.documentid and di.goodsitemid = g.goodsitemid and di.disctype = 5 and d.workshiftid = $shift.id$ ">
      <text>  Списано   : </text><var name="dsum" minwidth="10" maxwidth="all" afterpoint="2" align="right"/><br/>
</select>
<text fillsymbol="=" maxwidth="all"/><br/>
</report>