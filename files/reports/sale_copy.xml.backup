<?xml version="1.0" encoding="UTF-8"?>
<!-- Шаблон копии чека продажи. Объединение одинаковых позиций и группировка по полю штрих-код. -->
<report name = "sale_copy" type="document" cached="true" title="Копия чека продажи">
<select query="SELECT shopcode,w.shiftnum ws FROM workshift w, document d WHERE w.workshiftid = d.workshiftid AND d.documentid = $document.id$">

<text align="center" fillsymbol=" " maxwidth="all">Магазин Материк</text><br/>
<text align="center" fillsymbol=" " maxwidth="all">ООО "ЭРНИС"</text><br/>
<text align="center" fillsymbol=" " maxwidth="all">КОПИЯ КАССОВОГО ЧЕКА</text><br/>
<!--<text align="left">Сумма НДС:</text><var align="left" name="ws" numberformat="0" maxwidth="all"/><br/>-->
<!--
<text align="center" fillsymbol="*" maxwidth="all"> К О П И Я </text><br/>-->
<!--<text align="center" fillsymbol=" " maxwidth="all">ЧЕК ПРОДАЖИ #$cash.code$.$shift.num$.$document.num$</text><br/>-->
<text align="center" fillsymbol=" " maxwidth="all">ЧЕК ПРОДАЖИ #$cash.code$.$ws$.$document.num$</text><br/>
<text align="center" fillsymbol=" " maxwidth="all">КАССИР: $cash.code$ $user.name$</text><br/>
</select>
<select query="select time_end from document where documentid= $document.id$">
<var name="time_end" dateformat="d2/mm/yyyy"/><text> </text><var name="time_end" dateformat="hh:mi"/><br/>
</select>

<text fillsymbol="=" maxwidth="all"/><br/>
<select query="select bcode dname from documents.goodsitem where documentid = $document.id$ and opcode not in (1000, 1004)">
<text> </text><br/>
<var name="dname" align="center" maxwidth="all"/><br/>
<text> </text><br/>-->
<select query="select case opcode when 52 then text_const.text1 else goodsitem.bcode end bcode, 
					CAST((case opcode when 52 then concat(text_const.text2 , goodsitem.deptcode)
						else goodsitem.name end) AS CHAR) name, 
					dictionaries.units.name unit, sum(if(goodsitem.opcode in (54, 56), -goodsitem.bquant, goodsitem.bquant)) bquant, goodsitem.pricei price, 
					sum(if(goodsitem.opcode in (54, 56), -goodsitem.sumi, goodsitem.sumi)) sumn, sum(if(goodsitem.opcode in (54, 56), -goodsitem.sumb, goodsitem.sumb)) sumb, vatcode1, vatcode2, vatcode3, vatcode4, 
					vatcode5, vatrate1, vatrate2, vatrate3, vatrate4, vatrate5, sum(vatsum1) vatsum1, 
					sum(vatsum2) vatsum2, sum(vatsum3) vatsum3, sum(vatsum4) vatsum4, sum(vatsum5) vatsum5 
				from documents.goodsitem left join dictionaries.units on measure = dictionaries.units.code 
					left join text_const on text_const.code = 1 
				where documentid = $document.id$ and goodsitem.bcode='$dname$' and goodsitem.opcode not in (1000, 1004) 
				 group by 1, 2, dictionaries.units.name, goodsitem.pricei, vatcode1, 
				 vatcode2, vatcode3, vatcode4, vatcode5, vatrate1, vatrate2, vatrate3, vatrate4, vatrate5">
<extvar name="name"  maxwidth="36" width="36" minwidth="21" split="bychar" quoted = "false"/>
	    <text>Штрихкод:              </text>  <var name="bcode" minwidth="13" align="right"/><br/>
	    <!--<var name="bcode" minwidth="15" align="right">-->
            <var name="bquant" numberformat="8.3"/><text> </text><var name="unit"/><text> * </text>
            <var name="price" numberformat="9.2"/><text> = </text><var name="sumn" numberformat=".2" align="right" fillsymbol=" " maxwidth="all" minwidth="11"/><br/>

            <select query="select if($sumn$ &gt; $sumb$, 'СО СКИДКОЙ', 'С НАДБАВКОЙ') discname , abs(($sumn$ - $sumb$) / $sumn$ * 100) discval from DUAL where not $sumn$ = $sumb$">
                <var name="discname" maxwidth="all" align="right"/><text align="right"> </text>
		<var name="discval" numberformat="10.2" align="right"/>
		<text align="right">%</text><var name="sumb" numberformat="10.2" align="right" minwidth="15"/><br/>
            </select>

<select query="select name vatname from dictionaries.vat where code=$vatcode1$">
<text maxwidth="14" align="right">В ТОМ ЧИСЛЕ </text>
<var name="vatname"/>
<text> (</text>
<var name="vatrate1" numberformat=".2"/>
<text>%) = </text>
<var name="vatsum1" numberformat=".2"/>
<br/>
</select>
</select>
</select>
<!-- Поиск и вывод на печать сторнированных позиций в чеке -->
    <select query="select st.bcode, st.name, st.bquant, st.sumb, st.price
                    from stornogoodsitem st where st.documentid = $document.id$ group by st.stornogoodsitemid">
        <text>Сторно: </text><br/>
        <extvar name="name"  maxwidth="36" width="36" minwidth="21" split="bychar" quoted = "false"/>
	    <text>Штрихкод:              </text>  <var name="bcode" minwidth="13" align="right"/><br/>
        <var name="bquant" numberformat="8.3"/><text> </text><text> * </text>
        <var name="price" numberformat="9.2"/><text> = </text>
        <var name="sumb" numberformat=".2" align="right" fillsymbol=" " maxwidth="all"/><br/>
    </select>
<select query="select 1 from (select sum(if(g.opcode not in (1000, 1004), 1, 0)) rp, sum(if(g.opcode in (1000, 1004), 1, 0)) pp from documents.goodsitem g where g.documentid = $document.id$ and g.opcode ) t where t.rp &lt;&gt; 0 and t.pp &lt;&gt; 0">
<text fillsymbol="-" maxwidth="all"/><br/>
</select>
<select query="select p.accountnumber account, p.amount, '0.00' commission, p.providername from documents.goodsitem g, documents.paymentitem p where g.documentid = $document.id$ and g.paymentitemid = p.paymentitemid and g.opcode in (1000, 1004) group by p.paymentid">
<var name="providername"/><br/>
<var name="account"/><sbr/><var name="amount" numberformat=".2" align="right" fillsymbol=" " maxwidth="all"/><br/>
<text>    В Т.Ч. КОМИССИЯ</text><var name="commission" align="right" fillsymbol=" " maxwidth="all"/><br/>
</select>
<text fillsymbol="-" maxwidth="all"/><br/>
<select query="select count(*) p from goodsitem where documentid = $document.id$ ">
<text align="left">ПОЗИЦИЙ:</text><var align="right" name="p" numberformat="04" maxwidth="all"/><br/>
</select>
<select query="select sum2, sumb from document where documentid = $document.id$ ">
<select query="select if($sum2$ &gt; $sumb$, 'CКИДКА', 'НАДБАВКА') dname , if($sum2$ &gt; $sumb$, $sum2$-$sumb$,$sumb$-$sum2$) dval from DUAL where not $sumb$=$sum2$">
<text>СУММА ЧЕКА:</text><var name="sum2" align="right" numberformat=".2" maxwidth="all"/><br/>
<var name="dname"/><text>:</text><var name="dval" align="right" numberformat=".2" maxwidth="all"/><br/>
</select>

<select query="SELECT SUM(discsum) dsum FROM discitem LEFT JOIN goodsitem ON discitem.goodsitemid= goodsitem.goodsitemid WHERE goodsitem.documentid= $document.id$ AND discitem.discmode=5 HAVING SUM(discsum) &gt; 0">
<text>СКИДКА НА НАБОР:</text><var name="dsum" align="right" numberformat=".2" maxwidth="all"/><br/>
</select>

<select query="select cardname from discitem inner join (select goodsitemid from goodsitem where documentid = $document.id$) as gi on discitem.goodsitemid = gi.goodsitemid and discitem.discmode = 2 group by 1">
<text>КАРТА </text><var name="cardname"/><br/>
</select>
<text align="left">ИТОГО:</text><var align="right" name="sumb" numberformat=".2" maxwidth="all"/><br/>
</select>




<!--операции с бонусами-->
<!-- <select query="SELECT number, bonusbalance FROM carditem WHERE documentid = $document.id$ GROUP BY 1,2">
<text maxwidth="all" fillsymbol="=">=</text><br/>
<text>Бонусов на начало:</text><var align="right" maxwidth="all" name="bonusbalance" numberformat=".2"/><br/>
<select query="select coalesce(sum(sumb), 0.0) s1 from moneyitem where documentid = $document.id$ and opcode = 70 and cardnum = '$number$'">
<text>Бонусов потрачено:</text><var align="right" name="s1" numberformat=".2" maxwidth="all"/><br/>
</select>
<select query="select coalesce(sum(amount), 0.0) s2 from bonusitem where documentid = $document.id$ and cardnumber = '$number$' and opcode = 1200">
<text>Бонусов получено:</text><var align="right" name="s2" numberformat=".2" maxwidth="all"/><br/>
</select>
<select query="select number, bonusbalance + gain - spend ost from
(select number, bonusbalance,
coalesce ((select sum(amount) from bonusitem where documentid = $document.id$ and cardnumber = number and opcode = 1200), 0) gain,
coalesce ((select sum(sumb) from moneyitem where documentid = $document.id$ and opcode = 70 and cardnum = number), 0) spend
from carditem where documentid = $document.id$ group by 1,2) a">
<text>Бонусов осталось:</text><var align="right" maxwidth="all" name="ost" numberformat=".2"/><br/>
</select>
</select>
-->

<select query="select md.opcode, v.chr, sum(md.sumb) got from moneyitem md left join dictionaries.valut v on md.valcode = v.code where  md.documentid= $document.id$ and md.opcode = 70 group by 1, 2 order by 1">
<text>ПОЛУЧЕНО </text><var name="chr" minwidth="4" align="right"/><text>:</text>
<var name="got" maxwidth="all" align="right" numberformat=".2"/><br/>
</select>
<select query="select md.opcode, v.chr, sum(md.sumb) chg from moneyitem md left join dictionaries.valut v on md.valcode = v.code where md.documentid= $document.id$ and md.opcode = 72 group by 1, 2 order by 1">
<text>СДАЧА    </text><var name="chr" minwidth="4" align="right"/><text>:</text>
<var name="chg" maxwidth="all" align="right" numberformat=".2"/><br/>
</select>
<br/><br/>
<text align="left" fillsymbol=" " maxwidth="all">Ставка НДС 16.5394%</text><br/>

<op var="sumnds" set="0"/>
<select query="select sumb * 16.5394/100 sumnds from document where documentid = $document.id$">
<text align="left">Сумма НДС:</text><var align="left" name="sumnds" numberformat=".2" maxwidth="all"/><br/>
 </select>


<select query="select time_end from document where documentid= $document.id$">
<text align="center" fillsymbol=" " maxwidth="all"> Цель приобретения - </text><br/>
<text align="center" fillsymbol=" " maxwidth="all"> для собственного потребления</text><br/>
<br/><br/>
<text align="center" fillsymbol=" " maxwidth="all">Копия верна</text><br/>
<text align="center" fillsymbol=" " maxwidth="all">ООО "ЭРНИС" УНН 100057478</text><br/>
<text align="center" fillsymbol=" " maxwidth="all">ГИПЕРМАРКЕТ "МАТЕРИК"</text><br/>
<br/>
<text align="left" fillsymbol="_" maxwidth="all">Котнроллер-кассир</text><br/>
<text align="center" fillsymbol=" " maxwidth="all">КАССИР: $user.name$</text><br/>
<text>Дата: </text><var name="time_end" dateformat="d2/mm/yyyy"/><br/>
</select>
<!--
<select query="SELECT opcode FROM goodsitem WHERE goodsitem.documentid = $document.id$ AND goodsitem.opcode = 1000 GROUP BY OPCODE">
<text align="center" fillsymbol=" " maxwidth="all">по вопросам приема платежей</text><br/>
<text align="center" fillsymbol=" " maxwidth="all">обращайтесь в службу поддержки</text><br/>
<text align="center" fillsymbol=" " maxwidth="all">PINPAY EXPRESS</text><br/>
<text align="center" fillsymbol=" " maxwidth="all">8-913-468-77-77, 8 (383) 227-03-54</text><br/>
<select query="SELECT providername, providerphone FROM goodsitem, paymentitem 
    WHERE goodsitem.documentid = $document.id$ AND goodsitem.paymentitemid = paymentitem.paymentitemid  
        AND goodsitem.opcode = 1000 AND providerphone IS NOT NULL GROUP BY 1,2">
<text align="center" fillsymbol=" " maxwidth="all">служба поддержки $providername$</text><br/>
<text align="center" fillsymbol=" " maxwidth="all">$providerphone$</text><br/>
</select>
<select query="SELECT terminalcode, terminaladdress FROM goodsitem, paymentitem 
    WHERE goodsitem.documentid = $document.id$ AND goodsitem.paymentitemid = paymentitem.paymentitemid  
        AND goodsitem.opcode = 1000 AND providerphone IS NOT NULL GROUP BY 1,2">
<text align="center" fillsymbol=" " maxwidth="all">терминал $terminalcode$</text><br/>
<text align="center" fillsymbol=" " maxwidth="all">$terminaladdress$</text><br/>
</select>
</select>
-->
<text align="center" fillsymbol="*" maxwidth="all"> К О П И Я </text>
</report>
 
